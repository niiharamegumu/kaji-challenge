openapi: 3.0.3
info:
  title: KajiChalle API
  version: 0.3.0
servers:
  - url: http://localhost:8080
security:
  - cookieAuth: []
paths:
  /health:
    get:
      operationId: health
      security: []
      summary: Health check
      responses:
        '200':
          description: OK
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/HealthResponse'

  /v1/auth/google/start:
    get:
      operationId: getAuthGoogleStart
      security: []
      summary: Start Google OIDC authorization
      responses:
        '200':
          description: Authorization URL generated
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/AuthStartResponse'

  /v1/auth/google/callback:
    get:
      operationId: getAuthGoogleCallback
      security: []
      summary: Handle Google OIDC callback and issue one-time exchange code
      parameters:
        - in: query
          name: code
          required: true
          schema:
            type: string
        - in: query
          name: state
          required: true
          schema:
            type: string
      responses:
        '200':
          description: Callback handled
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/AuthCallbackResponse'

  /v1/auth/sessions/exchange:
    post:
      operationId: postAuthSessionsExchange
      security: []
      summary: Exchange one-time code for app session token
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/AuthSessionExchangeRequest'
      responses:
        '200':
          description: Authenticated
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/AuthSessionResponse'

  /v1/auth/logout:
    post:
      operationId: postAuthLogout
      summary: Revoke current session token
      responses:
        '204':
          description: Logged out

  /v1/me:
    get:
      operationId: getMe
      summary: Current user
      responses:
        '200':
          description: Current user
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/MeResponse'
  /v1/me/nickname:
    patch:
      operationId: patchMeNickname
      summary: Update current user nickname
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/UpdateNicknameRequest'
      responses:
        '200':
          description: Nickname updated
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/UpdateNicknameResponse'
  /v1/me/color:
    patch:
      operationId: patchMeColor
      summary: Update current user color
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/UpdateColorRequest'
      responses:
        '200':
          description: Color updated
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/UpdateColorResponse'

  /v1/teams/invites:
    post:
      operationId: postTeamInvite
      summary: Create invite code
      requestBody:
        required: false
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/CreateInviteRequest'
      responses:
        '201':
          description: Invite created
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/InviteCodeResponse'
  /v1/teams/invites/current:
    get:
      operationId: getTeamCurrentInvite
      summary: Get current team invite code
      responses:
        '200':
          description: Current invite
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/InviteCodeResponse'
  /v1/teams/current:
    patch:
      operationId: patchTeamCurrent
      summary: Update current team name
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/UpdateCurrentTeamRequest'
      responses:
        '200':
          description: Team updated
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/TeamInfoResponse'
  /v1/teams/current/members:
    get:
      operationId: getTeamCurrentMembers
      summary: List current team members by joined date
      responses:
        '200':
          description: Team members
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/TeamMembersResponse'

  /v1/teams/join:
    post:
      operationId: postTeamJoin
      summary: Join team by invite code
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/JoinTeamRequest'
      responses:
        '200':
          description: Joined
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/JoinTeamResponse'
  /v1/teams/leave:
    post:
      operationId: postTeamLeave
      summary: Leave current team and create a new own team
      responses:
        '200':
          description: Left and recreated own team
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/JoinTeamResponse'

  /v1/tasks:
    get:
      operationId: listTasks
      summary: List tasks in current team
      parameters:
        - name: type
          in: query
          schema:
            $ref: '#/components/schemas/TaskType'
      responses:
        '200':
          description: List tasks
          content:
            application/json:
              schema:
                type: object
                required: [items]
                properties:
                  items:
                    type: array
                    items:
                      $ref: '#/components/schemas/Task'
    post:
      operationId: postTask
      summary: Create task
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/CreateTaskRequest'
      responses:
        '201':
          description: Task created
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Task'

  /v1/tasks/{taskId}:
    patch:
      operationId: patchTask
      summary: Update task
      parameters:
        - in: path
          name: taskId
          required: true
          schema:
            type: string
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/UpdateTaskRequest'
      responses:
        '200':
          description: Task updated
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Task'
    delete:
      operationId: deleteTask
      summary: Delete task
      parameters:
        - in: path
          name: taskId
          required: true
          schema:
            type: string
      responses:
        '204':
          description: Task deleted

  /v1/tasks/{taskId}/completions/toggle:
    post:
      operationId: postTaskCompletionToggle
      summary: Update task completion in target period
      parameters:
        - in: path
          name: taskId
          required: true
          schema:
            type: string
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/ToggleTaskCompletionRequest'
      responses:
        '200':
          description: Completion toggled
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/TaskCompletionResponse'

  /v1/penalty-rules:
    get:
      operationId: listPenaltyRules
      summary: List penalty rules in current team
      parameters:
        - in: query
          name: includeDeleted
          required: false
          schema:
            type: boolean
            default: false
      responses:
        '200':
          description: Penalty rules
          content:
            application/json:
              schema:
                type: object
                required: [items]
                properties:
                  items:
                    type: array
                    items:
                      $ref: '#/components/schemas/PenaltyRule'
    post:
      operationId: postPenaltyRule
      summary: Create penalty rule
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/CreatePenaltyRuleRequest'
      responses:
        '201':
          description: Penalty rule created
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/PenaltyRule'

  /v1/penalty-rules/{ruleId}:
    patch:
      operationId: patchPenaltyRule
      summary: Update penalty rule
      parameters:
        - in: path
          name: ruleId
          required: true
          schema:
            type: string
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/UpdatePenaltyRuleRequest'
      responses:
        '200':
          description: Penalty rule updated
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/PenaltyRule'
    delete:
      operationId: deletePenaltyRule
      summary: Delete penalty rule
      parameters:
        - in: path
          name: ruleId
          required: true
          schema:
            type: string
      responses:
        '204':
          description: Penalty rule deleted

  /v1/tasks/overview:
    get:
      operationId: getTaskOverview
      summary: Task overview payload
      responses:
        '200':
          description: Task overview payload
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/TaskOverviewResponse'

  /v1/penalty-summaries/monthly:
    get:
      operationId: getPenaltySummaryMonthly
      summary: Monthly penalty summary
      parameters:
        - name: month
          in: query
          required: false
          schema:
            type: string
            pattern: '^\\d{4}-\\d{2}$'
      responses:
        '200':
          description: Monthly summary
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/MonthlyPenaltySummary'

  /v1/admin/close-day:
    post:
      operationId: postAdminCloseDay
      summary: Run day close now
      responses:
        '200':
          description: Closed
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/CloseResponse'

  /v1/admin/close-week:
    post:
      operationId: postAdminCloseWeek
      summary: Run week close now
      responses:
        '200':
          description: Closed
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/CloseResponse'

  /v1/admin/close-month:
    post:
      operationId: postAdminCloseMonth
      summary: Run month close now
      responses:
        '200':
          description: Closed
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/CloseResponse'

components:
  securitySchemes:
    cookieAuth:
      type: apiKey
      in: cookie
      name: kaji_session

  schemas:
    ErrorResponse:
      type: object
      required: [message]
      properties:
        message:
          type: string

    HealthResponse:
      type: object
      required: [status]
      properties:
        status:
          type: string
          example: ok

    AuthStartResponse:
      type: object
      required: [authorizationUrl]
      properties:
        authorizationUrl:
          type: string
          format: uri

    AuthCallbackResponse:
      type: object
      required: [exchangeCode]
      properties:
        exchangeCode:
          type: string

    AuthSessionExchangeRequest:
      type: object
      required: [exchangeCode]
      properties:
        exchangeCode:
          type: string
          minLength: 1

    AuthSessionResponse:
      type: object
      required: [user]
      properties:
        user:
          $ref: '#/components/schemas/User'

    User:
      type: object
      required: [id, email, displayName, createdAt]
      properties:
        id:
          type: string
        email:
          type: string
        displayName:
          type: string
        colorHex:
          type: string
          nullable: true
        createdAt:
          type: string
          format: date-time

    MeResponse:
      type: object
      required: [user, memberships]
      properties:
        user:
          $ref: '#/components/schemas/User'
        memberships:
          type: array
          items:
            $ref: '#/components/schemas/TeamMembership'

    TeamMembership:
      type: object
      required: [teamId, role, teamName]
      properties:
        teamId:
          type: string
        role:
          type: string
          enum: [owner, member]
        teamName:
          type: string

    CreateInviteRequest:
      type: object
      properties:
        expiresInHours:
          type: integer
          minimum: 1
          maximum: 720
          default: 72

    InviteCodeResponse:
      type: object
      required: [code, teamId, expiresAt]
      properties:
        code:
          type: string
        teamId:
          type: string
        expiresAt:
          type: string
          format: date-time

    JoinTeamRequest:
      type: object
      required: [code]
      properties:
        code:
          type: string
          minLength: 6
          maxLength: 64

    JoinTeamResponse:
      type: object
      required: [teamId]
      properties:
        teamId:
          type: string

    UpdateCurrentTeamRequest:
      type: object
      required: [name]
      properties:
        name:
          type: string
          minLength: 1
          maxLength: 50

    TeamInfoResponse:
      type: object
      required: [teamId, name]
      properties:
        teamId:
          type: string
        name:
          type: string

    TeamMember:
      type: object
      required: [userId, displayName, effectiveName, joinedAt, role]
      properties:
        userId:
          type: string
        displayName:
          type: string
        nickname:
          type: string
          nullable: true
        effectiveName:
          type: string
        colorHex:
          type: string
          nullable: true
        joinedAt:
          type: string
          format: date-time
        role:
          type: string
          enum: [owner, member]

    TeamMembersResponse:
      type: object
      required: [items]
      properties:
        items:
          type: array
          items:
            $ref: '#/components/schemas/TeamMember'

    UpdateNicknameRequest:
      type: object
      required: [nickname]
      properties:
        nickname:
          type: string
          maxLength: 30

    UpdateNicknameResponse:
      type: object
      required: [nickname, effectiveName]
      properties:
        nickname:
          type: string
        effectiveName:
          type: string

    UpdateColorRequest:
      type: object
      required: [colorHex]
      properties:
        colorHex:
          type: string
          nullable: true

    UpdateColorResponse:
      type: object
      required: [colorHex]
      properties:
        colorHex:
          type: string
          nullable: true

    TaskType:
      type: string
      enum: [daily, weekly]

    Task:
      type: object
      required:
        [id, teamId, title, type, penaltyPoints, requiredCompletionsPerWeek, createdAt, updatedAt]
      properties:
        id:
          type: string
        teamId:
          type: string
        title:
          type: string
        notes:
          type: string
        type:
          $ref: '#/components/schemas/TaskType'
        penaltyPoints:
          type: integer
          minimum: 0
          maximum: 1000
        assigneeUserId:
          type: string
        requiredCompletionsPerWeek:
          type: integer
          minimum: 1
          maximum: 7
        createdAt:
          type: string
          format: date-time
        updatedAt:
          type: string
          format: date-time

    CreateTaskRequest:
      type: object
      required: [title, type, penaltyPoints]
      properties:
        title:
          type: string
          minLength: 1
          maxLength: 100
        notes:
          type: string
          maxLength: 500
        type:
          $ref: '#/components/schemas/TaskType'
        penaltyPoints:
          type: integer
          minimum: 0
          maximum: 1000
        assigneeUserId:
          type: string
        requiredCompletionsPerWeek:
          type: integer
          minimum: 1
          maximum: 7

    UpdateTaskRequest:
      type: object
      properties:
        title:
          type: string
          minLength: 1
          maxLength: 100
        notes:
          type: string
          maxLength: 500
        penaltyPoints:
          type: integer
          minimum: 0
          maximum: 1000
        assigneeUserId:
          type: string
        requiredCompletionsPerWeek:
          type: integer
          minimum: 1
          maximum: 7

    ToggleTaskCompletionRequest:
      type: object
      required: [targetDate]
      properties:
        targetDate:
          type: string
          format: date
        action:
          type: string
          enum: [toggle, increment, decrement]
          default: toggle

    TaskCompletionResponse:
      type: object
      required: [taskId, targetDate, completed, weeklyCompletedCount]
      properties:
        taskId:
          type: string
        targetDate:
          type: string
          format: date
        completed:
          type: boolean
        weeklyCompletedCount:
          type: integer

    TaskCompletionActor:
      type: object
      required: [userId, effectiveName]
      properties:
        userId:
          type: string
        effectiveName:
          type: string
        colorHex:
          type: string
          nullable: true

    TaskCompletionSlot:
      type: object
      required: [slot]
      properties:
        slot:
          type: integer
        actor:
          $ref: '#/components/schemas/TaskCompletionActor'
          nullable: true

    PenaltyRule:
      type: object
      required: [id, teamId, threshold, name, createdAt, updatedAt]
      properties:
        id:
          type: string
        teamId:
          type: string
        threshold:
          type: integer
          minimum: 1
        name:
          type: string
        description:
          type: string
        deletedAt:
          type: string
          format: date-time
          nullable: true
        createdAt:
          type: string
          format: date-time
        updatedAt:
          type: string
          format: date-time

    CreatePenaltyRuleRequest:
      type: object
      required: [threshold, name]
      properties:
        threshold:
          type: integer
          minimum: 1
        name:
          type: string
          minLength: 1
          maxLength: 100
        description:
          type: string
          maxLength: 500

    UpdatePenaltyRuleRequest:
      type: object
      properties:
        threshold:
          type: integer
          minimum: 1
        name:
          type: string
          minLength: 1
          maxLength: 100
        description:
          type: string
          maxLength: 500

    TaskOverviewDailyTask:
      type: object
      required: [task, completedToday]
      properties:
        task:
          $ref: '#/components/schemas/Task'
        completedToday:
          type: boolean
        completedBy:
          $ref: '#/components/schemas/TaskCompletionActor'
          nullable: true

    TaskOverviewWeeklyTask:
      type: object
      required: [task, weekCompletedCount, requiredCompletionsPerWeek, completionSlots]
      properties:
        task:
          $ref: '#/components/schemas/Task'
        weekCompletedCount:
          type: integer
        requiredCompletionsPerWeek:
          type: integer
          minimum: 1
          maximum: 7
        completionSlots:
          type: array
          items:
            $ref: '#/components/schemas/TaskCompletionSlot'

    TaskOverviewResponse:
      type: object
      required: [month, today, elapsedDaysInWeek, monthlyPenaltyTotal, dailyTasks, weeklyTasks]
      properties:
        month:
          type: string
          example: 2026-02
        today:
          type: string
          format: date
        elapsedDaysInWeek:
          type: integer
        monthlyPenaltyTotal:
          type: integer
        dailyTasks:
          type: array
          items:
            $ref: '#/components/schemas/TaskOverviewDailyTask'
        weeklyTasks:
          type: array
          items:
            $ref: '#/components/schemas/TaskOverviewWeeklyTask'

    MonthlyTaskStatusItem:
      type: object
      required: [taskId, title, type, penaltyPoints, completed, isDeleted, completionSlots]
      properties:
        taskId:
          type: string
        title:
          type: string
        notes:
          type: string
          maxLength: 500
        type:
          $ref: '#/components/schemas/TaskType'
        penaltyPoints:
          type: integer
        completed:
          type: boolean
        isDeleted:
          type: boolean
        completionSlots:
          type: array
          items:
            $ref: '#/components/schemas/TaskCompletionSlot'

    MonthlyTaskStatusGroup:
      type: object
      required: [date, items]
      properties:
        date:
          type: string
          format: date
        items:
          type: array
          items:
            $ref: '#/components/schemas/MonthlyTaskStatusItem'

    MonthlyPenaltySummary:
      type: object
      required: [month, teamId, dailyPenaltyTotal, weeklyPenaltyTotal, totalPenalty, isClosed, triggeredPenaltyRuleIds, taskStatusByDate]
      properties:
        month:
          type: string
        teamId:
          type: string
        dailyPenaltyTotal:
          type: integer
        weeklyPenaltyTotal:
          type: integer
        totalPenalty:
          type: integer
        isClosed:
          type: boolean
        triggeredPenaltyRuleIds:
          type: array
          items:
            type: string
        taskStatusByDate:
          type: array
          items:
            $ref: '#/components/schemas/MonthlyTaskStatusGroup'

    CloseResponse:
      type: object
      required: [closedAt, month]
      properties:
        closedAt:
          type: string
          format: date-time
        month:
          type: string
